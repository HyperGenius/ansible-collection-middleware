# ------------------------------------------------------------------------------
# Nginx Reverse Proxy Configuration for {{ my_app_name }}
# Managed by Ansible - Do not edit manually!
# ------------------------------------------------------------------------------

# --- 1. Upstream Definition (転送先グループ) ---
upstream {{ my_app_upstream_name | default('backend_cluster') }} {
    # メインの転送先
    server {{ my_app_backend_host | default('127.0.0.1') }}:{{ my_app_backend_port | default('8080') }};

    # 複数台構成またはバックアップサーバー構成時
    # server 10.0.0.2:8080;
    # server 10.0.0.3:8080 backup;
}

# --- 2. Server Block (公開側の設定) ---
server {
    listen      {{ my_app_listen_port | default(80) }};
    server_name {{ my_app_domain | default('_') }};

    # --- Logging ---
    access_log  /var/log/nginx/{{ my_app_name }}_access.log main;
    error_log   /var/log/nginx/{{ my_app_name }}_error.log warn;

    # --- Proxy Settings ---
    location / {
        # upstreamへ転送
        proxy_pass http://{{ my_app_upstream_name | default('backend_cluster') }}

        # --- Header Forwarding ---
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # --- Timeouts ---
        proxy_read_timeout {{ my_app_read_timeout | default(60) }}s;
        proxy_connect_timeout {{ my_app_connect_timeout | default(60) }}s;
        
        # WebSocketを使う場合はコメントアウト
        # proxy_http_version 1.1;
        # proxy_set_header Upgrade $http_upgrade;
        # proxy_set_header Connection "upgrade";
    }

    # 静的ファイルだけNginxで直接配信して負荷を下げるサンプル
    # location /static/ {
    #     alias /var/www/{{ my_app_name }}/static/;
    #     expires 30d;
    # }
}
