---
# Create conf.d directory for extension mechanism
- name: Create zabbix_server.conf.d directory
  ansible.builtin.file:
    path: "{{ zabbix_server_core_conf_dir }}"
    state: directory
    owner: zabbix
    group: zabbix
    mode: '0750'

# Deploy main configuration file
- name: Configure zabbix_server.conf
  ansible.builtin.template:
    src: zabbix_server.conf.j2
    dest: "{{ zabbix_server_core_conf_file }}"
    owner: zabbix
    group: zabbix
    mode: '0640'
  notify: Restart Zabbix Server

# Optionally create password file in conf.d if password is provided
# This is mainly for testing; in production, the project should manage this file
- name: Create DBPassword configuration file (when password is provided)
  ansible.builtin.copy:
    content: |
      # Database password for Zabbix Server
      # This file was auto-generated by the role for testing/convenience
      DBPassword={{ zabbix_server_core_db_password }}
    dest: "{{ zabbix_server_core_conf_dir }}/dbpassword.conf"
    owner: zabbix
    group: zabbix
    mode: '0640'
  when: zabbix_server_core_db_password is defined
  notify: Restart Zabbix Server
