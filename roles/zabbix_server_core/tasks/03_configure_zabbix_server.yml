---
# 1. zabbix_server.conf.dディレクトリの作成
- name: Create zabbix_server.conf.d directory
  ansible.builtin.file:
    path: "{{ zabbix_server_core_conf_dir }}"
    state: directory
    owner: zabbix
    group: zabbix
    mode: '0750'

# 2. zabbix_server.confをtemplatesからコピー
- name: Configure zabbix_server.conf
  ansible.builtin.template:
    src: zabbix_server.conf.j2
    dest: "{{ zabbix_server_core_conf_file }}"
    owner: zabbix
    group: zabbix
    mode: '0640'
  notify: Restart Zabbix Server

# 3. DBPasswordファイルをconf.dにコピー (テスト用)
# 本番環境ではプロジェクトがこのファイルを管理する必要があります。
- name: Create DBPassword configuration file (when password is provided)
  ansible.builtin.copy:
    content: |
      # Database password for Zabbix Server
      # This file was auto-generated by the role for testing/convenience
      DBPassword={{ zabbix_server_core_db_password }}
    dest: "{{ zabbix_server_core_conf_dir }}/dbpassword.conf"
    owner: zabbix
    group: zabbix
    mode: '0640'
  when: zabbix_server_core_db_password is defined
  notify: Restart Zabbix Server
