---
# 1. 不要なコンフィグファイルを削除 (パッケージが置いたゴミ掃除)
# default.d/php.conf があると起動しないため確実に消す
- name: Remove conflicting Nginx configs provided by packages
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/nginx/conf.d/default.conf
    - /etc/nginx/conf.d/php-fpm.conf
    - /etc/nginx/default.d/php.conf  # これが諸悪の根源
  notify: Restart nginx

# 2. Zabbix用のNginx設定をテンプレートから配置 (上書き)
# replaceではなくtemplateを使うことで、中身を完全に制御下に置く
- name: Deploy Zabbix Nginx configuration
  ansible.builtin.template:
    src: zabbix_nginx.conf.j2
    dest: /etc/nginx/conf.d/zabbix.conf
    owner: root
    group: root
    mode: '0644'
  notify: Restart nginx
