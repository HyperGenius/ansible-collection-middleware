---
# Zabbixエージェント2の設定ファイルを配置 (Windows)
- name: Deploy Zabbix Agent 2 configuration
  ansible.windows.win_template:
    src: zabbix_agent2_win.conf.j2
    dest: "{{ zabbix_agent_core_config_file }}"
    backup: true
  register: zabbix_agent_core_config_result

# Zabbixエージェント2サービスの再起動 (設定ファイル変更時)
- name: Restart Zabbix Agent 2 service (if config changed)
  ansible.windows.win_service:
    name: "{{ zabbix_agent_core_service_name }}"
    state: restarted
  when: zabbix_agent_core_config_result.changed

# Zabbixエージェント2サービスの起動と有効化 (Windows)
- name: Ensure Zabbix Agent 2 service is started and enabled
  ansible.windows.win_service:
    name: "{{ zabbix_agent_core_service_name }}"
    state: "{{ zabbix_agent_core_service_state }}"
    start_mode: "{{ 'auto' if zabbix_agent_core_service_enabled else 'manual' }}"
